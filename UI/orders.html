{% extends "layout.html" %}
{% block head %}
<script>
const translations = JSON.parse("{{ content | tojson | safe }}");
</script>
<style>
.orders-hero {
  background: linear-gradient(135deg, #ff6b3554 0%, #00d5ff6a 100%);
  padding: 3rem 0;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.orders-hero::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background:
    radial-gradient(circle at 40% 60%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
    radial-gradient(circle at 60% 40%, rgba(255, 119, 198, 0.3) 0%, transparent 50%);
  animation: float 20s ease-in-out infinite;
}

.orders-title {
  font-size: 2.5rem;
  font-weight: 800;
  text-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
  margin-bottom: 1rem;
  background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.orders-subtitle {
  font-size: 1.2rem;
  font-weight: 300;
  text-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
}

.orders-container {
  background: rgba(128, 128, 128, 0.1);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(128, 128, 128, 0.2);
  border-radius: 20px;
  padding: 2rem;
  margin-bottom: 2rem;
}

.category-header {
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid rgba(128, 128, 128, 0.3);
}

.category-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 0.5rem;
}

.sub-category-header {
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid rgba(128, 128, 128, 0.2);
}

.sub-category-title {
  font-size: 1.2rem;
  font-weight: 500;
  color: rgba(255, 255, 255, 0.8);
  margin-bottom: 0.5rem;
}

.order-card {
  background: rgba(128, 128, 128, 0.1);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(128, 128, 128, 0.2);
  border-radius: 16px;
  overflow: hidden;
  transition: all 0.3s ease;
  height: 100%;
  position: relative;
}

.order-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(0, 212, 255, 0.1) 100%);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.order-card:hover::before {
  opacity: 1;
}

.order-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
  border-color: rgba(255, 107, 53, 0.3);
}

.order-image {
  height: 200px;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.order-card:hover .order-image {
  transform: scale(1.05);
}

.order-status-badge {
  position: absolute;
  top: 15px;
  right: 15px;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  z-index: 2;
}

.status-pending {
  background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
  color: white;
}

.status-delivered {
  background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
  color: white;
}

.status-cancelled {
  background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
  color: white;
}

.order-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 1rem;
  line-height: 1.3;
}

.order-detail-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.detail-label {
  font-size: 0.9rem;
  color: rgba(255, 255, 255, 0.7);
  font-weight: 500;
}

.detail-value {
  font-size: 0.9rem;
  color: #ffffff;
  font-weight: 600;
}

.price-highlight {
  color: #ff6b35 !important;
  font-size: 1.1rem !important;
}

.discount-info {
  background: rgba(255, 107, 107, 0.1);
  border: 1px solid rgba(255, 107, 107, 0.3);
  border-radius: 8px;
  padding: 0.5rem;
  margin: 0.5rem 0;
}

.discount-text {
  color: #ff6b6b;
  font-size: 0.85rem;
  font-weight: 600;
}

.order-checkbox {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(128, 128, 128, 0.3);
}

.checkbox-input {
  width: 18px;
  height: 18px;
  margin-right: 0.5rem;
  cursor: pointer;
  appearance: none;
  border: 2px solid #ff6b35;
  border-radius: 4px;
  background: rgba(255, 255, 255, 0.1);
  position: relative;
  transition: all 0.3s ease;
}

.checkbox-input:checked {
  background: #ff6b35;
  border-color: #ff6b35;
}

.checkbox-input:checked::after {
  content: '✓';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 12px;
  font-weight: bold;
}

.checkbox-input:hover {
  border-color: #00d4ff;
  background: rgba(255, 107, 53, 0.2);
}

.checkbox-label {
  font-size: 0.9rem;
  color: rgba(255, 255, 255, 0.8);
  cursor: pointer;
}

.bulk-actions {
  background: rgba(128, 128, 128, 0.1);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(128, 128, 128, 0.2);
  border-radius: 16px;
  padding: 2rem;
  margin-top: 2rem;
  text-align: center;
}

.bulk-actions-title {
  font-size: 1.3rem;
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 1.5rem;
}

.btn-bulk {
  padding: 0.75rem 2rem;
  font-weight: 600;
  border-radius: 12px;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin: 0 0.5rem;
  font-size: 0.9rem;
}

.btn-cancel-bulk {
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
  border: none;
  color: white;
}

.btn-cancel-bulk:hover {
  background: linear-gradient(135deg, #ee5a24 0%, #ff6b6b 100%);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
}

.btn-cancel-bulk:disabled {
  background: rgba(255, 107, 107, 0.3);
  transform: none;
  box-shadow: none;
  cursor: not-allowed;
}

.btn-checkout-bulk {
  background: linear-gradient(135deg, #00d4ff 0%, #4facfe 100%);
  border: none;
  color: white;
}

.btn-checkout-bulk:hover {
  background: linear-gradient(135deg, #4facfe 0%, #00d4ff 100%);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
}

.btn-checkout-bulk:disabled {
  background: rgba(79, 172, 254, 0.3);
  transform: none;
  box-shadow: none;
  cursor: not-allowed;
}

.payment-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  display: none;
  z-index: 1000;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.payment-modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(128, 128, 128, 0.1);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(128, 128, 128, 0.2);
  border-radius: 20px;
  padding: 2rem;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.payment-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid rgba(128, 128, 128, 0.3);
}

.payment-modal-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #ffffff;
  margin: 0;
}

.btn-close-modal {
  background: none;
  border: none;
  color: rgba(255, 255, 255, 0.7);
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 50%;
  transition: all 0.3s ease;
}

.btn-close-modal:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #ffffff;
}

.payment-form-row {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.payment-form-group {
  flex: 1;
}

.form-label {
  font-size: 0.9rem;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 0.5rem;
  display: block;
}

.payment-input{
  width: 100%;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  color: #ffffff;
  padding: 0.75rem;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.payment-select{
  width: 100%;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  color: #ffffff;
  padding: 0.75rem;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.payment-select option {
  color: #ffffff;
  background: rgba(0, 0, 0, 0.8);
}

.payment-select:focus, .payment-input:focus {
  background: rgba(255, 255, 255, 0.08);
  border-color: #ff6b35;
  box-shadow: 0 0 0 0.2rem rgba(255, 107, 53, 0.25);
  outline: none;
}

.payment-details-panel {
  background: rgba(255, 107, 53, 0.1);
  border: 1px solid rgba(255, 107, 53, 0.3);
  border-radius: 12px;
  padding: 1rem;
  margin-top: 1rem;
  display: none;
}

.payment-details-title {
  font-size: 1rem;
  font-weight: 600;
  color: #ff6b35;
  margin-bottom: 0.5rem;
}

.payment-account-info {
  font-size: 0.9rem;
  color: rgba(255, 255, 255, 0.8);
  margin-bottom: 0.5rem;
}

.account-number {
  font-weight: 700;
  color: #ffffff;
}

.payment-instruction {
  font-size: 0.8rem;
  color: rgba(255, 255, 255, 0.7);
  font-style: italic;
}

.total-amount-display {
  text-align: center;
  margin: 1.5rem 0;
  padding: 1rem;
  background: rgba(128, 128, 128, 0.1);
  border-radius: 12px;
}

.total-label {
  font-size: 0.9rem;
  color: rgba(255, 255, 255, 0.7);
  margin-bottom: 0.5rem;
}

.total-value {
  font-size: 1.8rem;
  font-weight: 800;
  color: #ff6b35;
}

.btn-confirm-payment {
  width: 100%;
  background: linear-gradient(135deg, #ff6b35 0%, #00d4ff 100%);
  border: none;
  padding: 1rem;
  font-weight: 600;
  border-radius: 12px;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: white;
}

.btn-confirm-payment:hover:not(:disabled) {
  background: linear-gradient(135deg, #00d4ff 0%, #ff6b35 100%);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
}

.btn-confirm-payment:disabled {
  background: rgba(255, 107, 53, 0.3);
  transform: none;
  box-shadow: none;
  cursor: not-allowed;
}

.otp-info {
  background: rgba(79, 172, 254, 0.1);
  border: 1px solid rgba(79, 172, 254, 0.3);
  border-radius: 8px;
  padding: 0.75rem;
  margin-bottom: 1rem;
  text-align: center;
}

.otp-info-text {
  font-size: 0.9rem;
  color: rgba(255, 255, 255, 0.8);
  margin: 0;
}

.otp-info-text strong {
  color: #4facfe;
}

.otp-timer {
  font-size: 0.8rem;
  color: rgba(255, 255, 255, 0.7);
  margin-top: 0.5rem;
  text-align: center;
}

.btn-send-otp {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  border: none;
  padding: 0.5rem 1rem;
  font-weight: 600;
  border-radius: 8px;
  transition: all 0.3s ease;
  color: white;
  font-size: 0.8rem;
  width: 100%;
  margin-top: 0.5rem;
}

.btn-send-otp:hover:not(:disabled) {
  background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
}

.btn-send-otp:disabled {
  background: rgba(79, 172, 254, 0.3);
  transform: none;
  box-shadow: none;
  cursor: not-allowed;
}

.empty-orders {
  text-align: center;
  padding: 4rem 2rem;
  background: rgba(128, 128, 128, 0.1);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(128, 128, 128, 0.2);
  border-radius: 20px;
}

.empty-icon {
  font-size: 4rem;
  color: rgba(255, 107, 53, 0.5);
  margin-bottom: 1.5rem;
}

.empty-title {
  font-size: 1.8rem;
  font-weight: 700;
  color: #ffffff;
  margin-bottom: 1rem;
}

.empty-text {
  font-size: 1.1rem;
  color: rgba(255, 255, 255, 0.7);
  margin-bottom: 2rem;
}

.btn-shop-now {
  background: linear-gradient(135deg, #ff6b35 0%, #00d4ff 100%);
  border: none;
  padding: 1rem 2rem;
  font-weight: 600;
  border-radius: 12px;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: white;
}

.btn-shop-now:hover {
  background: linear-gradient(135deg, #00d4ff 0%, #ff6b35 100%);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
}

.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #ffffff;
  animation: spin 1s ease-in-out infinite;
  margin-right: 0.5rem;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .orders-title {
    font-size: 2rem;
  }

  .payment-form-row {
    flex-direction: column;
    gap: 0;
  }

  .bulk-actions {
    padding: 1.5rem;
  }

  .btn-bulk {
    margin: 0.25rem;
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
  }

  .order-detail-row {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.25rem;
  }
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('input[name="selected_orders"]');
    const cancelBtn = document.getElementById('cancel-selected');
    const checkoutBtn = document.getElementById('checkout-selected');
    const paymentModal = document.getElementById('payment-modal');
    const paymentMethodSelect = document.getElementById('payment-method');
    const paymentDetails = document.getElementById('payment-details');
    const totalDisplay = document.getElementById('total-amount');
    const closeModalBtn = document.querySelector('.btn-close-modal');
    const otpInfo = document.getElementById('otp-info');
    const sendOtpBtn = document.getElementById('send-otp-btn');
    const otpTimer = document.getElementById('otp-timer');
    const confirmBtn = document.querySelector('.btn-confirm-payment');
    const referenceInput = document.getElementById('reference');
    const referenceLabel = document.getElementById('reference-label');

    let otpCountdown = 0;
    let selectedOrderIds = [];
    let otpTimerInterval = null;

    function updateButtons() {
        const checked = document.querySelectorAll('input[name="selected_orders"]:checked');
        const hasChecked = checked.length > 0;
        cancelBtn.disabled = !hasChecked;
        checkoutBtn.disabled = !hasChecked;
    }

    function calculateTotal() {
        let total = 0;
        const checked = document.querySelectorAll('input[name="selected_orders"]:checked');
        checked.forEach(cb => {
            const price = parseFloat(cb.dataset.price);
            total += price;
        });
        totalDisplay.textContent = '₱' + total.toFixed(2);
    }

    function getSelectedOrderIds() {
        const checked = document.querySelectorAll('input[name="selected_orders"]:checked');
        return Array.from(checked).map(cb => parseInt(cb.value));
    }

    function startOtpTimer() {
        // Clear any existing timer
        if (otpTimerInterval) {
            clearInterval(otpTimerInterval);
        }
        
        otpCountdown = 300; // 5 minutes
        updateOtpTimer();
        
        otpTimerInterval = setInterval(() => {
            otpCountdown--;
            updateOtpTimer();
            if (otpCountdown <= 0) {
                clearInterval(otpTimerInterval);
                sendOtpBtn.disabled = false;
                sendOtpBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Resend OTP';
                otpTimer.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>OTP expired. Please request a new one.';
                confirmBtn.disabled = true;
            }
        }, 1000);
    }

    function updateOtpTimer() {
        const minutes = Math.floor(otpCountdown / 60);
        const seconds = otpCountdown % 60;
        otpTimer.innerHTML = `<i class="fas fa-clock me-2"></i>OTP expires in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function resetModal() {
        referenceInput.value = '';
        sendOtpBtn.disabled = false;
        sendOtpBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Resend OTP';
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Confirm Payment';
        paymentMethodSelect.value = 'Cash on Delivery';
        paymentDetails.style.display = 'none';
        otpTimer.textContent = '';
        otpInfo.innerHTML = '<p class="otp-info-text"><i class="fas fa-info-circle me-2"></i>An 8-digit OTP will be automatically sent to your email for payment verification.</p>';
        
        // Clear timer
        if (otpTimerInterval) {
            clearInterval(otpTimerInterval);
            otpTimerInterval = null;
        }
    }

    function autoSendOTP() {
        if (selectedOrderIds.length === 0) {
            alert('No orders selected');
            return false;
        }

        // Show loading state
        sendOtpBtn.disabled = true;
        sendOtpBtn.innerHTML = '<span class="loading-spinner"></span>Sending OTP...';

        fetch('/request_order_payment_otp', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({order_ids: selectedOrderIds})
        })
        .then(response => response.json())
        .then(data => {
            if (data.ok) {
                // Show success message
                otpInfo.innerHTML = `<p class="otp-info-text"><i class="fas fa-check-circle me-2" style="color: #66bb6a;"></i><strong>8-digit OTP sent to your email!</strong> Please check your inbox and enter the code in the reference field.</p>`;
                
                // Start the timer
                startOtpTimer();
                
                // Enable confirm button
                confirmBtn.disabled = false;
                
                // Reset send OTP button
                sendOtpBtn.disabled = true;
                sendOtpBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Resend OTP';
                
                // Auto-focus on reference input
                setTimeout(() => {
                    referenceInput.focus();
                }, 500);
                
            } else {
                alert('Failed to send OTP: ' + data.msg);
                sendOtpBtn.disabled = false;
                sendOtpBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Resend OTP';
            }
        })
        .catch(error => {
            alert('Error sending OTP. Please try again.');
            sendOtpBtn.disabled = false;
            sendOtpBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Resend OTP';
        });
        
        return true;
    }

    // Event Listeners
    checkboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            updateButtons();
            if (paymentModal.style.display !== 'none') {
                calculateTotal();
            }
        });
    });

    cancelBtn.addEventListener('click', function() {
        const checked = document.querySelectorAll('input[name="selected_orders"]:checked');
        if (checked.length === 0) return;
        if (confirm('Are you sure you want to cancel the selected orders?')) {
            const form = document.getElementById('cancel-form');
            // Clear previous hidden inputs
            const hiddenInputs = form.querySelectorAll('input[name="selected_orders"]');
            hiddenInputs.forEach(input => input.remove());
            // Add checked ones
            checked.forEach(cb => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'selected_orders';
                hiddenInput.value = cb.value;
                form.appendChild(hiddenInput);
            });
            form.submit();
        }
    });

    checkoutBtn.addEventListener('click', function() {
        const checked = document.querySelectorAll('input[name="selected_orders"]:checked');
        if (checked.length === 0) return;
        selectedOrderIds = getSelectedOrderIds();
        paymentModal.style.display = 'flex';
        calculateTotal();
        resetModal();
        
        // Auto-send OTP when modal opens
        setTimeout(() => {
            autoSendOTP();
        }, 500);
    });

    closeModalBtn.addEventListener('click', function() {
        paymentModal.style.display = 'none';
    });

    paymentModal.addEventListener('click', function(e) {
        if (e.target === paymentModal) {
            paymentModal.style.display = 'none';
        }
    });

    paymentMethodSelect.addEventListener('change', function() {
        const method = this.value;

        if (method === 'Cash on Delivery') {
            paymentDetails.style.display = 'none';
            referenceLabel.textContent = translations.reference_label || 'Reference Number';
            referenceInput.placeholder = 'Enter reference (optional)';
            referenceInput.required = false;
            confirmBtn.disabled = false;
            // Clear OTP info for Cash on Delivery
            otpInfo.innerHTML = '<p class="otp-info-text"><i class="fas fa-info-circle me-2"></i>No OTP required for Cash on Delivery.</p>';
        } else {
            paymentDetails.style.display = 'block';
            if (method === 'GCash') {
                document.getElementById('account-label').textContent = 'GCash Number:';
                document.getElementById('account-number').textContent = '09917452192';
            } else if (method === 'PayMaya') {
                document.getElementById('account-label').textContent = 'PayMaya Account:';
                document.getElementById('account-number').textContent = '09917452192';
            }
            referenceLabel.textContent = 'OTP Code';
            referenceInput.placeholder = 'Enter 8-digit OTP code';
            referenceInput.required = true;
            confirmBtn.disabled = true; // Disable until OTP is verified
            
            // Auto-send OTP when switching to digital payment
            if (selectedOrderIds.length > 0) {
                autoSendOTP();
            }
        }
    });

    // Manual OTP resend button
    sendOtpBtn.addEventListener('click', function() {
        autoSendOTP();
    });

    // Handle form submission with AJAX
    document.getElementById('payment-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const paymentMethod = paymentMethodSelect.value;
        const otp = referenceInput.value;

        if (selectedOrderIds.length === 0) {
            alert('No orders selected');
            return;
        }

        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="loading-spinner"></span>Processing...';

        if (paymentMethod === 'Cash on Delivery') {
            // Direct form submission for Cash on Delivery
            const form = document.getElementById('payment-form');
            
            // Remove any existing hidden inputs
            const existingHiddenInputs = form.querySelectorAll('input[name="selected_orders"]');
            existingHiddenInputs.forEach(input => input.remove());
            
            // Add selected order IDs as hidden inputs
            selectedOrderIds.forEach(id => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'selected_orders';
                hiddenInput.value = id;
                form.appendChild(hiddenInput);
            });
            
            // Submit the form normally
            form.submit();
        } else {
            // OTP verification for GCash/PayMaya
            if (!otp) {
                alert('Please enter the 8-digit OTP code');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm Payment';
                return;
            }

            if (otp.length !== 8) {
                alert('Please enter a valid 8-digit OTP code');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm Payment';
                return;
            }

            fetch('/verify_payment_otp', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    otp: otp,
                    purpose: 'order',
                    order_ids: selectedOrderIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    alert('Payment verified and completed successfully!');
                    window.location.href = data.redirect || '/orders';
                } else {
                    alert('Failed to verify payment: ' + data.msg);
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Confirm Payment';
                }
            })
            .catch(error => {
                alert('Error verifying payment');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm Payment';
            });
        }
    });

    // Initialize
    updateButtons();
});
</script>
{% endblock %}

{% block content %}

<!-- ORDERS HERO -->
<section class="orders-hero">
  <div class="container">
    <h1 class="orders-title">{{ content['orders_title'] }}</h1>
    <p class="orders-subtitle">{{ content['orders_subtitle'] }}</p>
  </div>
</section>

<!-- ORDERS CONTENT -->
<div class="container">
  {% if orders %}
  <div class="orders-container">
    <!-- PENDING ORDERS -->
    {% set pending_orders = orders | selectattr('status', 'equalto', 'pending') | rejectattr('payment_status', 'equalto', 'paid') | list %}
    {% if pending_orders %}
    <div class="category-header">
      <h3 class="category-title">{{ content['pending_orders_title'] }}</h3>
    </div>
    <div class="row g-4 mb-4">
      {% for o in pending_orders %}
      <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
        <div class="order-card h-100">
          {% if o.image %}
          <div class="position-relative">
            <img src="{{ url_for('static', filename='uploads/' + o.image) }}"
                 class="order-image w-100" alt="{{ o.product_name }}">
            <span class="order-status-badge status-{{ o.status.lower() }}">{{ o.status }}</span>
          </div>
          {% else %}
          <div class="position-relative">
            <img src="{{ url_for('static', filename='img/logo.png') }}"
                 class="order-image w-100" alt="{{ o.product_name }}">
            <span class="order-status-badge status-{{ o.status.lower() }}">{{ o.status }}</span>
          </div>
          {% endif %}

          <div class="card-body d-flex flex-column p-4">
            <h5 class="order-title">{{ o.product_name }}</h5>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['quantity_label'] }}</span>
              <span class="detail-value">{{ o.quantity }}</span>
            </div>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['original_price_label'] }}</span>
              <span class="detail-value">₱{{ "%.2f"|format(o.original_price or o.total_price) }}</span>
            </div>

            {% if o.discount_applied %}
            <div class="discount-info">
              <span class="discount-text">{{ content['discount_label'] }} {{ "%.0f"|format(o.discount_applied * 100) }}% (₱{{ "%.2f"|format((o.original_price or o.total_price) * o.discount_applied) }})</span>
            </div>
            {% endif %}

            <div class="order-detail-row">
              <span class="detail-label price-highlight">{{ content['final_price_label'] }}</span>
              <span class="detail-value price-highlight">₱{{ "%.2f"|format(o.total_price) }}</span>
            </div>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['payment_method_label'] }}</span>
              <span class="detail-value">{{ o.payment_method or "N/A" }}</span>
            </div>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['payment_status_label'] }}</span>
              <span class="detail-value">{{ o.payment_status or "N/A" }}</span>
            </div>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['order_date_label'] }}</span>
              <span class="detail-value">{{ o.order_date.strftime("%Y-%m-%d %H:%M") }}</span>
            </div>

            <div class="order-checkbox">
              <input type="checkbox" name="selected_orders" value="{{ o.id }}" class="checkbox-input" id="check_{{ o.id }}" data-price="{{ o.total_price }}">
              <label class="checkbox-label" for="check_{{ o.id }}">{{ content['select_label'] }}</label>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- PAID ORDERS NOT DELIVERED YET -->
    {% set paid_not_delivered = orders | selectattr('payment_status', 'equalto', 'paid') | rejectattr('status', 'equalto', 'delivered') | list %}
    {% if paid_not_delivered %}
    <div class="category-header">
      <h3 class="category-title">{{ content['paid_orders_title'] }}</h3>
    </div>
    <div class="row g-4 mb-4">
      {% for o in paid_not_delivered %}
      <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
        <div class="order-card h-100">
          {% if o.image %}
          <div class="position-relative">
            <img src="{{ url_for('static', filename='uploads/' + o.image) }}"
                 class="order-image w-100" alt="{{ o.product_name }}">
            <span class="order-status-badge status-{{ o.status.lower() }}">{{ o.status }}</span>
          </div>
          {% else %}
          <div class="position-relative">
            <img src="{{ url_for('static', filename='img/logo.png') }}"
                 class="order-image w-100" alt="{{ o.product_name }}">
            <span class="order-status-badge status-{{ o.status.lower() }}">{{ o.status }}</span>
          </div>
          {% endif %}

          <div class="card-body d-flex flex-column p-4">
            <h5 class="order-title">{{ o.product_name }}</h5>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['quantity_label'] }}</span>
              <span class="detail-value">{{ o.quantity }}</span>
            </div>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['original_price_label'] }}</span>
              <span class="detail-value">₱{{ "%.2f"|format(o.original_price or o.total_price) }}</span>
            </div>

            {% if o.discount_applied %}
            <div class="discount-info">
              <span class="discount-text">{{ content['discount_label'] }} {{ "%.0f"|format(o.discount_applied * 100) }}% (₱{{ "%.2f"|format((o.original_price or o.total_price) * o.discount_applied) }})</span>
            </div>
            {% endif %}

            <div class="order-detail-row">
              <span class="detail-label price-highlight">{{ content['final_price_label'] }}</span>
              <span class="detail-value price-highlight">₱{{ "%.2f"|format(o.total_price) }}</span>
            </div>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['payment_method_label'] }}</span>
              <span class="detail-value">{{ o.payment_method or "N/A" }}</span>
            </div>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['payment_status_label'] }}</span>
              <span class="detail-value">{{ o.payment_status or "N/A" }}</span>
            </div>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['order_date_label'] }}</span>
              <span class="detail-value">{{ o.order_date.strftime("%Y-%m-%d %H:%M") }}</span>
            </div>

            <div class="order-checkbox">
              <input type="checkbox" name="selected_orders" value="{{ o.id }}" class="checkbox-input" id="check_{{ o.id }}" data-price="{{ o.total_price }}">
              <label class="checkbox-label" for="check_{{ o.id }}">{{ content['select_label'] }}</label>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- DELIVERED ORDERS -->
    {% set delivered_orders = orders | selectattr('status', 'equalto', 'delivered') | list %}
    {% if delivered_orders %}
    <div class="category-header">
      <h3 class="category-title">{{ content['delivered_orders_title'] }}</h3>
    </div>
    <div class="row g-4 mb-4">
      {% for o in delivered_orders %}
      <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
        <div class="order-card h-100">
          {% if o.image %}
          <div class="position-relative">
            <img src="{{ url_for('static', filename='uploads/' + o.image) }}"
                 class="order-image w-100" alt="{{ o.product_name }}">
            <span class="order-status-badge status-{{ o.status.lower() }}">{{ o.status }}</span>
          </div>
          {% else %}
          <div class="position-relative">
            <img src="{{ url_for('static', filename='img/logo.png') }}"
                 class="order-image w-100" alt="{{ o.product_name }}">
            <span class="order-status-badge status-{{ o.status.lower() }}">{{ o.status }}</span>
          </div>
          {% endif %}

          <div class="card-body d-flex flex-column p-4">
            <h5 class="order-title">{{ o.product_name }}</h5>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['quantity_label'] }}</span>
              <span class="detail-value">{{ o.quantity }}</span>
            </div>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['original_price_label'] }}</span>
              <span class="detail-value">₱{{ "%.2f"|format(o.original_price or o.total_price) }}</span>
            </div>

            {% if o.discount_applied %}
            <div class="discount-info">
              <span class="discount-text">{{ content['discount_label'] }} {{ "%.0f"|format(o.discount_applied * 100) }}% (₱{{ "%.2f"|format((o.original_price or o.total_price) * o.discount_applied) }})</span>
            </div>
            {% endif %}

            <div class="order-detail-row">
              <span class="detail-label price-highlight">{{ content['final_price_label'] }}</span>
              <span class="detail-value price-highlight">₱{{ "%.2f"|format(o.total_price) }}</span>
            </div>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['payment_method_label'] }}</span>
              <span class="detail-value">{{ o.payment_method or "N/A" }}</span>
            </div>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['payment_status_label'] }}</span>
              <span class="detail-value">{{ o.payment_status or "N/A" }}</span>
            </div>

            <div class="order-detail-row">
              <span class="detail-label">{{ content['order_date_label'] }}</span>
              <span class="detail-value">{{ o.order_date.strftime("%Y-%m-%d %H:%M") }}</span>
            </div>

            <!-- No checkbox for delivered orders -->
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  <div class="bulk-actions">
    <h4 class="bulk-actions-title">{{ content['bulk_actions_title'] }}</h4>
    <button type="button" id="cancel-selected" class="btn-bulk btn-cancel-bulk" disabled>
      <i class="fas fa-times me-2"></i>{{ content['cancel_selected_button'] }}
    </button>
    <button type="button" id="checkout-selected" class="btn-bulk btn-checkout-bulk" disabled>
      <i class="fas fa-credit-card me-2"></i>{{ content['checkout_selected_button'] }}
    </button>
  </div>

  <!-- HIDDEN CANCEL FORM -->
  <form id="cancel-form" method="POST" action="{{ url_for('cancel_selected_orders') }}" style="display: none;">
    {% for o in orders %}
    <input type="checkbox" name="selected_orders" value="{{ o.id }}" style="display: none;">
    {% endfor %}
  </form>
  {% else %}
  <div class="empty-orders">
    <i class="fas fa-shopping-bag empty-icon"></i>
    <h3 class="empty-title">{{ content['no_orders_title'] }}</h3>
    <p class="empty-text">{{ content['no_orders_text'] }}</p>
    <a href="{{ url_for('shop') }}" class="btn-shop-now">
      <i class="fas fa-shopping-cart me-2"></i>{{ content['start_shopping_button'] }}
    </a>
  </div>
  {% endif %}
</div>

<!-- PAYMENT MODAL -->
<div id="payment-modal" class="payment-modal">
  <div class="payment-modal-content">
    <form id="payment-form" method="POST" action="{{ url_for('complete_payment') }}">
      <div class="payment-modal-header">
        <h3 class="payment-modal-title">{{ content['complete_payment_title'] }}</h3>
        <button type="button" class="btn-close-modal">&times;</button>
      </div>

      <div class="payment-form-row">
        <div class="payment-form-group">
          <label for="payment-method" class="form-label">{{ content['payment_method_label_modal'] }}</label>
          <select name="payment_method" id="payment-method" class="payment-select" required>
            <option value="Cash on Delivery">{{ content['cash_on_delivery'] }}</option>
            <option value="GCash">{{ content['gcash'] }}</option>
            <option value="PayMaya">{{ content['paymaya'] }}</option>
          </select>
        </div>
        <div class="payment-form-group">
          <label for="reference" class="form-label" id="reference-label">{{ content['reference_label'] }}</label>
          <input type="text" name="reference" id="reference" class="payment-input" placeholder="Enter reference" maxlength="8">
          <button type="button" id="send-otp-btn" class="btn-send-otp">
            <i class="fas fa-redo me-2"></i>Resend OTP
          </button>
        </div>
      </div>

      <div id="payment-details" class="payment-details-panel">
        <h4 class="payment-details-title">{{ content['payment_details_title'] }}</h4>
        <p class="payment-account-info">
          <strong id="account-label"></strong>
          <span class="account-number" id="account-number"></span>
        </p>
        <p class="payment-instruction">{{ content['payment_instruction'] }}</p>
      </div>

      <!-- OTP INFO -->
      <div id="otp-info" class="otp-info">
        <p class="otp-info-text"><i class="fas fa-info-circle me-2"></i>An 8-digit OTP will be automatically sent to your email for payment verification.</p>
      </div>

      <div id="otp-timer" class="otp-timer"></div>

      <div class="total-amount-display">
        <div class="total-label">{{ content['total_amount_label'] }}</div>
        <div class="total-value" id="total-amount">₱0.00</div>
      </div>

      <button type="submit" class="btn-confirm-payment" disabled>
        <i class="fas fa-check me-2"></i>{{ content['confirm_payment_button'] }}
      </button>
    </form>
  </div>
</div>


{% endblock %}